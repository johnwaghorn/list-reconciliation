# List Reconciliation Components

ID | Name | Type | Function | Description | In | Out
---|------|------|----------|-------------|----|-----
LR-01 | `gp_extract_input` | Bucket | File handling and storage  | The folder where the GP flat files will be dropped into that will trigger a Job to be created and the file reconciled. | GP Flat file from PCSE. | -
LR-02 | `validate_and_parse`  | Lambda | Validate | Pick up the GP Flat file from the inbound folder. Validate the file according to business rules. After processing the file, an entry in the DB will be added to track the status of the file. | GP Flat file from PCSE. | Fail: original file and summary of failures file. Pass: data added to database and flat file moved to pass folder
LR-03 | `jobs_table` | DynamoDB Table  | Jobs| TODO | TODO  | TODO
LR-04 | `feedback_failure` | Lambda | Feedback failure| Will collate failure errors and send them back to PCSE| File in the Fail folder  | Email failure statement to PCSE
LR-06 | `patient_records` | Bucket | Patient Records | A way to hold multiple patients that need to be looked up on PDS. This allows many patients to be processed simultaneously  | Patient Record| Patient Record
LR-07 | `pds_hydrate` | Lambda | PDS Hydrate| Triggered on a patient being added to the queue. Calls the PDS FHIR API for the given patient. Stores the PDS data in the DB alongside the GP data. Appends PDS data to the patients GP data. Passes onto LR-08. | Patient Record with just GP data | Patient Record with GP & PDS data
LR-08 | `demographic_comparison` | Lambda | Demographic comparisons | Receives the Patient record with both GP & PDS data. Runs basic comparison (is A = B exactly).Runs complex BA rules.Adds result of rules to the DB. | Patient Record with GP & PDS data | Rules that the patient has triggered
LR-09 | `scheduled_check` | Lambda | Scheduled checker | Checks if any practices are in the in flights table. If they are, check if we've processed all records for this practice. If we have: trigger the registration process (LR-10); trigger the demographic process (LR-15); remove the record from the in flights table; update the stats table | - | Trigger LR-10
LR-10 | `registration_orchestration` | Step function  | Registration Orchestration | Triggered by the schedule checker (LR-09). In parallel, sets off LR-11, LR-12 and LR-15. Once all processes have completed LR-14 is triggered. | Practice to process | On Practice not on PDS file; On PDS not on practice file; Identified demographic differences for PCSE
LR-11 | `gp_registration_status` | Lambda | Reg: On Practice not on PDS | Compares all the records on the GP Practice system against PDS, where the PDS practice code doesn't match the practice we're comparing against. Note: The file will only be outputted if there are any records that match this criteria. | Practice to process | On Practice not on PDS file
LR-12 | `pds_registration_status` | Lambda | Reg: On PDS not on Practice | Compares all the records on PDS against the GP Practice system, where the PDS practice code matches the practice we're comparing against, but the patient doesn't exist in the Practice data provided. Supplementary PDS data from DPS will be available in LR-22 to use. Note: The file will only be outputted if there are any records that match this criteria. | Practice to process | On PDS not on Practice file
LR-13 | `reg_diffs_output` | Bucket | Registration diff output files | This will store the outputs that are ready to be sent to PCSE | Output practice file(s) | -
LR-14 | `send_list_rec_results` | Lambda | Send output files to PCSE | Send output files to PCSE via MESH. Send accompanying email with the completed job stats along with the names of the files that correspond to the completed job in MESH so PCSE can download them. Email sent to PCSE. Update the database status | Practice to process | Output files sent to MESH
LR-15 | `process_demo_diffs` | Lambda | Demographic diff output | Query the DB for the given practice. Compare the rules to generate the specific outputs  Identified differences file. LR-17 If there is any Human Validation required for record(s), generate a JSON payload which will be sent via MESH to a process in Spine.  The Spine process will take the payload and generate a work item that is sent into DSA. LR-19 This will be an overall output which contains all of the discovered differences in a usable format for PCSE. Update the database status. | Practice to process | JSON payload for work item generation
LR-20 | `pds_reg_input` | Bucket | PDS data from DPS | This bucket will take the daily file of supplementary PDS data which will come from DPS via MESH.  | Flat file from DPS | -
LR-21 | `split_dps_extract` | Lambda | Split DPS extract | Take single file from LR-20 and split it up into an individual file per ODS Practice Code | Flat File from DPS | Individual flat files per practice
LR-22 | `pds_reg_output` | Bucket | Prepared PDS data from DPS | This will store the individual practice files which LR-12 will reference when in flight| Individual flat files per practice | -
LR-23 | `firehose_failure` | Bucket | Failed log forwarding collection | Log collection bucket if the Firehose fails to forward to Splunk | Logs | -
LR-24 | `save_records_to_s3` | Lambda | Save Records to S3 | TODO | TODO | TODO
LR-25 | `mesh_post_office` | Lambda | Mesh Post Office| This will move received Mesh messages into the Inbound List Reconciliation process. It will run on a 5 minute schedule, moving all files it can find in the Mesh mailbox inbound S3 directory. It will also check for an active flag, that we can turn of during an incident to stop data being processed if required. | Mesh Message files from the, external to List Reconciliation, Mesh handling infrastructure | Mesh Message file into the List Reconciliation process
LR-26 | `access_logs` | Bucket | Logging| Stores AWS logging of S3 bucket actions | TODO | TODO
LR-27 | `job_cleanup` | Lambda | Job Cleanup | Remove payloads for failed jobs from LR-23. Update status of stopped jobs to reflect their state. Remove job from InFlight table if exists. | JobId | -
LR-28 | `jobs_stats`| DynamoDB Table| Jobs Stats| TODO | TODO | TODO
LR-29 | `in_flight` | DynamoDB Table| In Flight | TODO | TODO | TODO
LR-30 | `demographics` | DynamoDB Table| Demographics | TODO | TODO | TODO
LR-31 | `demographics_differences` | DynamoDB Table| Demographics Differences | TODO | TODO | TODO
LR-32 | `firehose_transform` | Lambda | Firehose Transform | Transforms Cloudwatch logs into a Firehose stream for forwarding to Splunk | Cloudwatch Logs | Splunk Logs
LR-33 | `cloudwatch_to_splunk` | Firehose Stream | CloudWatch to Splunk Forwarding | Firehose stream for log forwarding | Logs | Logs
